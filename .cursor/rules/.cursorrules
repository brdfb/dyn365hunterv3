# Dyn365Hunter MVP - Cursor Rules

## Project Context
- **MVP Scope**: FastAPI + PostgreSQL, rule-based scoring, DNS/WHOIS analysis
- **Target**: ‚â§2 minute "kahvelik" analysis flow for sales team
- **MVP Status**: ‚úÖ Completed (G1-G14)
- **Post-MVP Sprint 1 (G14)**: ‚úÖ Completed - CSV Export + UI Mini
- **Post-MVP Sprint 2-5 (G15-G18)**: ‚úÖ Completed - Bulk Scan, Webhook, Notes/Tags/Favorites/PDF, ReScan/Alerts/Enhanced Scoring
- **Post-MVP Sprint 6 (G19)**: ‚úÖ Completed - Auth + UI + Advanced Features
- **UI Patch v1.1**: ‚úÖ Completed - Skor detay modal ve UX iyile≈ütirmeleri (2025-01-28)
- **G20: Domain Intelligence Layer**: ‚úÖ Completed - Local Provider, Tenant Size, DMARC Coverage (2025-01-28)
- **P0 Hardening (G19)**: ‚úÖ Completed - DB Connection Pooling, API Key Security, Structured Logging, Error Tracking, Health Checks
- **P1 Performance**: ‚úÖ Completed (2025-01-28) - Alembic, Distributed Rate Limiting, Caching, Bulk Operations, API Versioning
- **‚úÖ Stabilization Sprint**: ‚úÖ Completed (2025-01-28) - ‚úÖ G√ºn 1 Tamamlandƒ± ‚Üí ‚úÖ G√ºn 2 Tamamlandƒ± ‚Üí ‚úÖ G√ºn 3 Tamamlandƒ± - v1.1-stable (Enterprise-Ready / UI-Stable / Integration-Ready)
- **‚úÖ CSP P-Model Integration**: ‚úÖ DONE & PROD-READY (2025-01-29) - Production v1.1 Core Feature - Global CSP Priority Model (P1-P6), Commercial Segment & Heat, Technical Heat, Priority Category & Label, UI integration (P-badges, tooltips, score breakdown panel)
- **‚úÖ Production Bug Fixes**: ‚úÖ DONE & PROD-READY (2025-01-29) - DMARC Coverage bug fix, Risk Summary text fix, Score Modal provider-specific description
- **‚úÖ Sales Summary v1.1**: ‚úÖ DONE & PROD-READY (2025-01-29) - Intelligence Layer with reasoning capabilities, UX polished
- **üîÑ G21: Architecture Refactor**: üîÑ In Progress (2025-01-28) - Hunter Slimming to Core Signal Engine (No-Break Refactor Plan)
- **‚úÖ Partner Center Phase 2**: ‚úÖ Completed (2025-01-30) - Integration Roadmap Phase 2 (Tasks 2.1-2.6 + Phase 4-6 productization + Phase 7 production enablement completed, 59/59 tests passing, feature flag OFF, MVP-safe, production-ready)
- **‚úÖ Pre-D365 Roast Sprint**: ‚úÖ Completed (2025-01-30) - 5/5 critical fixes (security, idempotency, token cache, session lifecycle, retry backoff)
- **üîÑ Dynamics 365 Integration**: üîÑ In Progress (2025-01-30) - Backend %94 completed (Phase 2.5), UI completed (Phase 3), E2E runbook ready (Phase 2.9)
- **‚úÖ D365 Lead Push PoC**: ‚úÖ **COMPLETED** (2025-01-30) - Hunter ‚Üí D365 Lead Push working, Option Set mapping implemented
- **Completed (Post-MVP)**: Mini UI, CSV export, progress tracking, provider change tracking, duplicate prevention, domain validation, bulk scan, webhook, lead enrichment, notes/tags/favorites, PDF summaries, rescan infrastructure, alerts system, enhanced scoring, domain intelligence (G20), CSP P-Model (2025-01-29)

## Code Style & Standards

### Python
- Use type hints for all functions
- Follow PEP 8 (black formatter preferred)
- Use f-strings for string formatting
- Prefer explicit over implicit (no magic numbers/strings)
- Use `app/core/constants.py` for business logic thresholds (scores, expiry days, bulk limits)

### FastAPI
- Use Pydantic models for request/response validation
- Use dependency injection for DB sessions (`get_db()`)
- Return proper HTTP status codes (201 Created, 400 Bad Request, 404 Not Found, 500 Internal Server Error)
- Use async/await only if needed (DB I/O can be sync for MVP)

### Database
- Use SQLAlchemy ORM (no raw SQL except in schema.sql)
- Domain is UNIQUE key in `companies` table
- Use idempotent upsert for companies (ON CONFLICT DO UPDATE)
- Always use transactions for multi-step operations
- **Duplicate Prevention**: Delete existing LeadScore/DomainSignal before creating new ones (prevents duplicates)
- **Provider Change Tracking**: Log provider changes to `provider_change_history` table when detected
- **Change Detection**: History tables (`signal_change_history`, `score_change_history`) for tracking changes over time

### Error Handling
- DNS timeout: 10s max, return None/error status, set `scan_status='dns_timeout'`
- WHOIS timeout: 5s max, graceful fail (return None), set `scan_status='whois_failed'`
- RDAP timeout: 3s max (fallback to WHOIS)
- SMTP timeout: 3s max (for email validation)
- Invalid domain: Return 400 Bad Request with clear error message
- Never crash on external API failures (DNS/WHOIS) - continue with partial data
- Celery task timeout: 900s (15 minutes) per task

### Logging & PII
- **CRITICAL**: Log only domain, NEVER log email or company_name
- Use structured logging (JSON format preferred)
- Log level: INFO for normal operations, ERROR for failures, DEBUG for development

### Testing
- Write tests for all core functions (normalizer, analyzer, scorer)
- Test edge cases: invalid domains, timeouts, malformed CSV, missing MX records
- Use pytest with pytest-mock for mocking DNS/WHOIS
- Target: ‚â•70% code coverage for core modules
- All tests must pass before commit (214+ tests)
- CI/CD enforces: black formatting, flake8 linting, mypy type checking

## MVP Scope Discipline

### ‚úÖ IN SCOPE
- Health check (`GET /healthz`) - Database connection status
- Single domain ingestion (`POST /ingest/domain`)
- CSV/Excel ingestion (`POST /ingest/csv`) - parse + normalize + insert + optional auto-scan
  - CSV support (.csv)
  - Excel support (.xlsx, .xls)
  - Auto-detect columns (`auto_detect_columns` query parameter) for OSB Excel files
  - Auto-scan (`auto_scan=true` query parameter) - Automatically scan domains after ingestion
  - Progress tracking - Real-time job progress updates via `/jobs/{job_id}`
- Single domain scan (`POST /scan/domain`) - DNS + WHOIS + scoring
  - Provider change detection and logging
  - Duplicate prevention (delete old records before creating new ones)
- Leads query (`GET /leads` with filters)
- Single lead query (`GET /leads/{domain}`)
- Dashboard endpoint (`GET /dashboard`) - Aggregated statistics
- Priority Score feature - Lead prioritization (1-6 scale)
- Email generation (`POST /email/generate`) - Generic email addresses for domains
- Email validation (`POST /email/generate-and-validate`) - Syntax, MX, optional SMTP validation
- **Mini UI** (`/mini-ui/`) - Simple web interface for demo and internal use (API_BASE_URL configurable via `window.HUNTER_API_BASE_URL`)
- **CSV/Excel export** (`GET /leads/export`) - Export leads with filters
- **Provider change tracking** - Automatic detection and history logging
- **Duplicate prevention** - Automatic cleanup of duplicate records
- **Domain validation** - Enhanced validation to filter invalid domains
- **Bulk scan** (`POST /scan/bulk`) - Async bulk domain scanning with Celery + Redis
- **Webhook ingestion** (`POST /ingest/webhook`) - API key authenticated webhook endpoint
- **Lead enrichment** - Contact emails, quality score, LinkedIn pattern detection
- **Notes/Tags/Favorites** - CRM-lite features with session-based favorites
- **PDF summaries** (`GET /leads/{domain}/summary.pdf`) - Account summary PDF generation
- **ReScan infrastructure** (`POST /scan/{domain}/rescan`, `POST /scan/bulk/rescan`) - Manual and bulk rescan with change detection
- **Alerts system** (`GET /alerts`, `POST /alerts/config`) - Change alerts (MX, DMARC, expiry, score)
- **Enhanced scoring** - Signal-based improvements (DKIM none penalty, SPF multiple includes risk)
- Docker Compose setup
- Basic tests (8 test files)

### ‚ùå OUT OF SCOPE (Post-MVP - Sprint 6'da planlandƒ±)
- **Sprint 6 (G19)**: Auth + UI + Advanced Features - üìã Planlandƒ±
- **Still Out of Scope**: D365 adapter, `scripts/demo_run.sh`
- **Note**: Redis/Queue ve Scheduler Sprint 2-5'te eklendi (Celery + Redis)

## File Structure Rules

### Required Files (P0)
- `Dockerfile`, `docker-compose.yml`, `.dockerignore`
- `setup_dev.sh` (one-command setup)
- `.env.example` (all required env vars)
- `requirements.txt` (pinned versions)
- `app/main.py` (FastAPI app + `/healthz`)
- `app/config.py` (Pydantic Settings with `HUNTER_` prefix - use `HUNTER_DATABASE_URL`, `HUNTER_REDIS_URL`, etc.)
- `app/db/schema.sql` (PostgreSQL DDL)
- `app/db/models.py` (SQLAlchemy models) - Includes `ProviderChangeHistory` model
- `app/db/session.py` (DB session factory)
- `app/core/normalizer.py` (includes `is_valid_domain()`), `analyzer_dns.py`, `analyzer_whois.py`, `provider_map.py`, `scorer.py`, `merger.py`, `priority.py`, `importer.py`, `email_generator.py`, `email_validator.py`, `constants.py`, `change_detection.py`, `rescan.py`, `auto_tagging.py`, `notifications.py`
- `app/api/ingest.py`, `scan.py`, `leads.py`, `dashboard.py`, `email_tools.py`, `progress.py`, `jobs.py`, `bulk_scan.py`, `rescan.py`, `webhook.py`, `export.py`, `notes.py`, `tags.py`, `favorites.py`, `pdf.py`, `alerts.py`
- `app/data/providers.json`, `rules.json`
- `tests/test_scan_single.py`, `test_scorer_rules.py`, `test_ingest_csv.py`, `test_api_endpoints.py`, `test_priority.py`, `test_importer_autodetect.py`, `test_email_generator.py`, `test_email_validator.py`
- `README.md`

### File Naming
- Use snake_case for Python files
- Use kebab-case for shell scripts (`setup_dev.sh`)
- Use lowercase for JSON config files (`providers.json`, `rules.json`)

## Implementation Priorities

### P0 (Must Have)
- Docker setup, DB schema, FastAPI skeleton
- Health check endpoint (`/healthz`)
- Domain normalization, ingestion endpoints
- DNS/WHOIS analyzers, provider mapping, scoring
- Scan endpoint, leads API, dashboard endpoint
- Priority score calculation
- Basic tests, README

### P1 (Should Have - Performance & Infrastructure) ‚úÖ Completed (2025-01-28)
- ‚úÖ **Alembic Migration System** - Migration history tracking, rollback capability, schema drift detection
- ‚úÖ **Distributed Rate Limiting** - Redis-based rate limiting for multi-worker deployments
- ‚úÖ **Caching Layer** - Redis-based distributed caching (DNS, WHOIS, Provider, Scoring, Scan)
- ‚úÖ **Bulk Operations Optimization** - Batch processing, deadlock prevention, partial commit recovery
- ‚úÖ **API Versioning** - `/api/v1/` structure with backward compatibility
- **Reference**: `docs/active/P1-IMPLEMENTATION-PLAYBOOK.md` (completed, now reference guide)

### P2 (Nice to Have)
- Performance optimizations, additional test coverage

## Performance Targets
- Single domain scan: ‚â§10s (cold: ‚â§15s acceptable)
- API response: <1s for `/leads` query
- CSV/Excel ingestion: Parse + normalize + insert only (scan separate)
- Email generation: <1s response time
- Email validation (light): <1s response time (syntax + MX only)
- Email validation (full): 10-30s response time (with SMTP check)

## Data Files

### providers.json
- Must contain 10+ providers (M365, Google, Yandex, Hosting, Local, Unknown)
- Include MX root examples for each provider
- Format: `{"providers": [{"name": "M365", "mx_roots": ["outlook.com", "protection.outlook.com"], ...}]}`

### rules.json
- Must contain: `base_score`, `provider_points`, `signal_points`, `segment_rules`
- Segment rules order matters (evaluate top to bottom)
- Format: `{"base_score": 0, "provider_points": {"M365": 50, ...}, "signal_points": {"spf": 10, ...}, "segment_rules": [...]}`

## Docker & Development

### Docker Compose
- PostgreSQL 15-alpine with healthcheck
- FastAPI service with healthcheck
- Use `depends_on.condition: service_healthy` (not just `depends_on`)
- Volume mounts for hot-reload: `./app:/app/app`

### setup_dev.sh
- Check Docker/Docker Compose availability
- Copy `.env.example` to `.env` if not exists
- `docker-compose up -d`
- Wait for PostgreSQL healthcheck (max 30s)
- Run schema migration automatically (Python script or Alembic, NOT manual docker-compose exec)
- Verify `/healthz` endpoint
- Print access URLs

## Guardrails & Validation Rules

### Rate Limiting
- **DNS queries**: 10 req/s per worker (token bucket algorithm)
- **WHOIS queries**: 5 req/s per worker (token bucket algorithm)
- **API Key rate limiting**: Configurable per key (default: 60 req/min)
- Always use `wait_for_dns_rate_limit()` and `wait_for_whois_rate_limit()` in bulk operations

### Bulk Operation Limits
- **Maximum domains per bulk scan/rescan**: 1000 (use `MAX_BULK_SCAN_DOMAINS` from `app/core/constants.py`)
- Validate domain count before processing
- Return 400 Bad Request if limit exceeded

### Environment Variables
- **Always use `HUNTER_` prefix**: `HUNTER_DATABASE_URL`, `HUNTER_REDIS_URL`, etc.
- Load via Pydantic Settings (`app/config.py`)
- Never hardcode database/Redis URLs in code
- Provide defaults for development (Docker Compose service names)

### Constants & Magic Numbers
- **Never use magic numbers**: Use `app/core/constants.py` for all thresholds
- Score thresholds: `MIGRATION_READY_SCORE`, `PRIORITY_1_SCORE`, etc.
- Expiry thresholds: `EXPIRE_SOON_DAYS`
- Bulk limits: `MAX_BULK_SCAN_DOMAINS`

### API Key Authentication
- **Webhook endpoints**: Require `X-API-Key` header
- Use `verify_api_key()` dependency for protected endpoints
- Rate limit per API key (configurable, default: 60 req/min)
- Store hashed keys (SHA-256), never plaintext

### Celery Task Configuration
- **Task timeout**: 900s (15 minutes) per task
- **Max retries**: 2 for transient failures
- **Concurrent tasks**: 5 per worker
- Always use rate limiting in Celery tasks

### Test Suite Guardrails
- **Test Count**: 497 tests (must maintain or increase)
- **Test Isolation**: Always use `db_session` fixture from `tests/conftest.py` for transaction-based isolation
- **Test Client**: Always use `client` fixture from `tests/conftest.py` for API tests
- **Integration Tests**: Use `@pytest.mark.requires_integration` and `redis_and_celery_available` fixture
- **Test Coverage**: ‚â•70% for core modules (`app/core/`)
- **Shared Fixtures**: Use `tests/conftest.py` fixtures for consistent test setup
- **Transaction Isolation**: Each test runs in isolated transaction with automatic rollback

### CI/CD Guardrails
- **Black formatting**: Enforced in CI (`.github/workflows/lint.yml`)
- **Flake8 linting**: Max line length 127, complexity ‚â§10
- **Type checking**: mypy (non-blocking, ignore missing imports)
- **Test coverage**: Codecov integration
- **All tests must pass**: 497 tests (CI/CD enforced)

### Database Migration & Reset Guardrails (CRITICAL - Lessons Learned 2025-01-29)
- **‚ö†Ô∏è schema.sql DEPRECATED**: `app/db/schema.sql` is **OUTDATED** and **MUST NOT** be used for database reset
  - **Reason**: Missing G20 columns (`tenant_size`, `local_provider`, `dmarc_coverage`) and CSP P-Model columns
  - **Impact**: Causes schema mismatches, missing columns, view errors, API failures
  - **Official Way**: Use `./scripts/reset_db_with_alembic.sh` or `Base.metadata.create_all()` + Alembic stamp
- **‚ö†Ô∏è Legacy SQL Migrations DEPRECATED**: `app/db/migrations/legacy/*.sql` files are **ARCHIVED** and **MUST NOT** be used
  - **Reason**: Transaction-unsafe, can fail mid-execution, out of sync with Alembic migrations
  - **Location**: Moved to `docs/archive/legacy-migrations/` (historical reference only)
  - **Official Way**: All schema changes must use Alembic migrations (`alembic/versions/`)
- **Database Reset Policy** (MANDATORY):
  - ‚ùå **DO NOT**: Use `schema.sql` or legacy SQL migrations for database reset
  - ‚ùå **DO NOT**: Combine `schema.sql` with legacy migrations (causes schema mismatches)
  - ‚úÖ **DO**: Use `./scripts/reset_db_with_alembic.sh` for database reset (official script)
  - ‚úÖ **DO**: Use `Base.metadata.create_all()` + Alembic stamp for fresh database setup
  - ‚úÖ **DO**: Always use Alembic migrations (`alembic upgrade head`) for schema changes
  - ‚úÖ **DO**: Verify critical columns after reset (`tenant_size`, `local_provider`, `dmarc_coverage`, P-Model columns)
- **Base Revision Migration Issues**:
  - Base revision (`08f51db8dce0_base_revision.py`) assumes tables exist (ALTER operations)
  - **Fix**: Use `Base.metadata.create_all()` first, then stamp base revision as applied
  - **Pattern**: Create tables from models ‚Üí Stamp migrations ‚Üí Run remaining migrations
- **API SQL Query Guardrails**:
  - ‚ùå **DO NOT**: SELECT columns that may not exist in view (`tenant_size`, `local_provider`, `dmarc_coverage`)
  - ‚úÖ **DO**: Use dynamic column checking or `getattr()` when reading from view
  - ‚úÖ **DO**: Verify view columns exist before using in SQL queries
  - **Example**: `leads_ready` view may not have all columns depending on migration state
- **leads_ready View Maintenance**:
  - View must include P-Model columns (`technical_heat`, `commercial_segment`, `commercial_heat`, `priority_category`, `priority_label`)
  - View must be updated when new columns are added to `lead_scores` table
  - CSP P-Model migration (`f786f93501ea`) handles view update dynamically
- **Migration Verification** (After Reset):
  - Verify `companies.tenant_size` exists (G20 column)
  - Verify `domain_signals.local_provider` and `domain_signals.dmarc_coverage` exist (G20 columns)
  - Verify `lead_scores` P-Model columns exist (`technical_heat`, `commercial_segment`, `commercial_heat`, `priority_category`, `priority_label`)
  - Verify `leads_ready` view has all expected columns
- **Reference Documentation**:
  - `docs/reference/PRODUCTION-DEPLOYMENT-GUIDE.md` - Migration Flow section (reset policy)
  - `docs/reference/TROUBLESHOOTING-GUIDE.md` - Database Reset Issues section
  - `docs/archive/legacy-migrations/README.md` - Why legacy migrations are deprecated

### D365 Lead Field Mapping Guardrails (CRITICAL - Added 2025-01-30)
- **‚ö†Ô∏è Logical Name Format**: All custom Hunter fields use `hnt_` prefix (confirmed from D365 Power Apps interface)
  - **Format**: `hnt_<field_name>` (camelCase)
  - **Examples**: `hnt_finalscore`, `hnt_segment`, `hnt_referralid`, `hnt_processingstatus`
  - **Source**: `docs/reference/LEAD-DATA-DICTIONARY.md` (v1.1 - confirmed from D365)
- **‚ö†Ô∏è Field Mapping Reference**: Always use `app/integrations/d365/mapping.py` for Hunter ‚Üí D365 field mapping
  - **Function**: `map_lead_to_d365(lead_data: Dict[str, Any])`
  - **Logical Names**: Use `hnt_` prefix (not `<prefix>_hunter_*`)
  - **Example**: `hnt_finalscore` (not `hunter_score` or `new_hunter_score`)
- **‚ö†Ô∏è Missing Fields**: Some fields from `mapping.py` not found in D365 (may be calculated or not yet implemented)
  - **Missing**: `hunter_priority_category`, `hunter_priority_label`, `hunter_technical_heat`, `hunter_commercial_segment`, `hunter_commercial_heat`, `hunter_is_partner_center_referral`
  - **Workaround**: `hunter_is_partner_center_referral` may be calculated from `hnt_referralid` (if not null = Yes)
  - **Action**: Check `docs/reference/LEAD-DATA-DICTIONARY.md` for confirmed field list before adding new fields
- **‚ö†Ô∏è Searchable Fields**: Some MLT fields are not searchable (for performance)
  - **Not Searchable**: `hnt_infrasummary`, `hnt_m365matchtags`, `hnt_HunterMLWeightJSON`
  - **Searchable**: Most other fields (scores, status, IDs, etc.)
  - **Reference**: `docs/reference/LEAD-DATA-DICTIONARY.md` - Searchable column
- **D365 Field Creation Policy** (MANDATORY):
  - ‚ùå **DO NOT**: Create D365 fields without checking `docs/reference/LEAD-DATA-DICTIONARY.md` first
  - ‚ùå **DO NOT**: Use logical names without `hnt_` prefix (confirmed prefix)
  - ‚ùå **DO NOT**: Add fields to `mapping.py` without verifying they exist in D365
  - ‚úÖ **DO**: Check `docs/reference/LEAD-DATA-DICTIONARY.md` for field list and logical names
  - ‚úÖ **DO**: Use `hnt_` prefix for all custom Hunter fields
  - ‚úÖ **DO**: Update `docs/reference/LEAD-DATA-DICTIONARY.md` when new fields are added to D365
  - ‚úÖ **DO**: Update `app/integrations/d365/mapping.py` to match D365 field names
- **Form Architecture Reference**:
  - ‚úÖ **DO**: Check `docs/reference/LEAD-FORM-ARCHITECTURE.md` for form structure and section placement
  - ‚úÖ **DO**: Follow form tree structure when adding new fields to forms
  - ‚úÖ **DO**: Place fields in appropriate sections (Hunter Intelligence, Partner Center, AI & Sync Analytics, Advanced Debug)
- **View Configuration Reference**:
  - ‚úÖ **DO**: Check `docs/reference/LEAD-VIEWS.md` for view configuration and recommended views
  - ‚úÖ **DO**: Use confirmed logical names (`hnt_*`) in view column definitions
  - ‚úÖ **DO**: Follow filter and sort criteria patterns from recommended views
- **Reference Documentation**:
  - `docs/reference/LEAD-DATA-DICTIONARY.md` - Full field list with logical names, data types, searchable properties (v1.1)
  - `docs/reference/LEAD-FORM-ARCHITECTURE.md` - Form structure, sections, tabs, control types (v1.1)
  - `docs/reference/LEAD-VIEWS.md` - View configuration, filters, sort criteria, recommended views (v1.0)
  - `docs/reference/LEAD-TABLE-FORM-ANALYSIS.md` - Original analysis document (v1.0)
  - `docs/reference/D365-OPTION-SET-MAPPING.md` - Option Set value mapping guide (string ‚Üí integer, added 2025-01-30)
  - `app/integrations/d365/mapping.py` - Hunter ‚Üí D365 field mapping implementation

### Script Safety Guardrails (CRITICAL - Added 2025-01-30)
- **‚ö†Ô∏è Production Database Reset Protection**: `scripts/reset_db_with_alembic.sh` **MUST** block production database resets
  - **Requirement**: Script checks `DATABASE_URL` for `prod|production` patterns
  - **Override**: Only allowed with explicit `FORCE_PRODUCTION_RESET=yes` flag
  - **Impact**: Prevents catastrophic data loss in production environments
  - **Policy**: This script is for DEV/TEST environments only
  - **Files**: `scripts/reset_db_with_alembic.sh`
- **‚ö†Ô∏è Production Deployment Protection**: `scripts/deploy_production.sh` **MUST** require explicit production flag
  - **Requirement**: Requires `FORCE_PRODUCTION=yes` when `ENVIRONMENT=production`
  - **Localhost Protection**: Blocks production deployments if `DATABASE_URL` points to localhost
  - **Impact**: Prevents accidental production deployments and wrong database usage
  - **Policy**: Production deployments must be explicit and intentional
  - **Files**: `scripts/deploy_production.sh`
- **Backup Integrity Check** (MANDATORY):
  - ‚úÖ **DO**: Validate backup file integrity before proceeding with deployment
  - ‚úÖ **DO**: Check for expected SQL format markers (PostgreSQL dump, CREATE TABLE, COPY/INSERT)
  - ‚úÖ **DO**: Warn if backup appears incomplete or corrupted
  - ‚ùå **DO NOT**: Proceed with deployment if backup integrity check fails (hard fail)
  - **Files**: `scripts/deploy_production.sh` - `backup_database()` function
- **Script Logging** (RECOMMENDED):
  - ‚úÖ **DO**: Enable logging for critical scripts (deployment, database reset)
  - ‚úÖ **DO**: Log to `./logs/scripts/` directory with timestamp
  - ‚úÖ **DO**: Use `tee` to log both to file and stdout
  - ‚úÖ **DO**: Allow disabling logging via `LOG_DIR=""` environment variable
  - **Files**: `scripts/reset_db_with_alembic.sh`, `scripts/deploy_production.sh`
- **Script Safety Policy** (MANDATORY):
  - ‚ùå **DO NOT**: Remove production protection guards from scripts
  - ‚ùå **DO NOT**: Bypass safety checks without explicit force flags
  - ‚ùå **DO NOT**: Deploy to production without backup integrity check
  - ‚úÖ **DO**: Always use official scripts (`reset_db_with_alembic.sh`, `deploy_production.sh`)
  - ‚úÖ **DO**: Verify environment variables before running scripts
  - ‚úÖ **DO**: Review script logs after execution
- **Reference Documentation**:
  - `docs/reference/PRODUCTION-DEPLOYMENT-GUIDE.md` - Safety Guards section
  - `CHANGELOG.md` - Security & Safety section (Script Safety Guards)

## Code Review Checklist

Before marking code as done, verify:
- [ ] Type hints added
- [ ] Error handling implemented (timeouts, invalid input)
- [ ] No PII in logs (domain only)
- [ ] Tests written for new functions (using `db_session` and `client` fixtures)
- [ ] MVP scope respected (Post-MVP features: bulk, webhook, export, rescan, alerts are now in scope)
- [ ] Docker Compose still works
- [ ] `/healthz` still responds
- [ ] Rate limiting applied (if bulk/external API calls)
- [ ] Bulk limits enforced (max 1000 domains)
- [ ] Constants used (no magic numbers)
- [ ] Environment variables use `HUNTER_` prefix
- [ ] Black formatting applied
- [ ] All tests passing (497 tests)
- [ ] Test isolation maintained (using shared fixtures)
- [ ] Documentation updated (README.md, CHANGELOG.md, docs/README.md)
- [ ] API contract respected (no breaking changes to frozen contracts)
- [ ] **Database reset uses official script** (`./scripts/reset_db_with_alembic.sh`) - NOT `schema.sql` or legacy migrations
- [ ] **API SQL queries** don't SELECT columns that may not exist in view (use dynamic checking or `getattr()`)
- [ ] **Script safety guards** are present (production reset protection, deployment guards, backup integrity check)
- [ ] **Production scripts** require explicit force flags (`FORCE_PRODUCTION=yes`, `FORCE_PRODUCTION_RESET=yes`)
- [ ] **D365 field mapping** uses confirmed logical names (`hnt_` prefix) from `docs/reference/LEAD-DATA-DICTIONARY.md`
- [ ] **D365 field creation** checked against `docs/reference/LEAD-DATA-DICTIONARY.md` before adding new fields
- [ ] **Form placement** follows `docs/reference/LEAD-FORM-ARCHITECTURE.md` structure and section guidelines

## Common Patterns

### Domain Normalization
```python
def normalize_domain(domain: str) -> str:
    # Extract domain from URL if needed
    # punycode decode, strip www, lowercase
    # validate domain format
    # return normalized domain or empty string if invalid

def is_valid_domain(domain: str) -> bool:
    # Check for invalid values (nan, web sitesi, etc.)
    # Validate domain format (dots, TLD, character rules)
    # return True if valid, False otherwise
```

### DNS Analysis
```python
def analyze_dns(domain: str) -> Dict[str, Any]:
    # timeout: 10s
    # return: {"mx_root": str, "spf": bool, "dkim": bool, "dmarc_policy": str}
    # on timeout: return None, set scan_status='dns_timeout'
```

### WHOIS Analysis
```python
def get_whois_info(domain: str) -> Optional[Dict[str, Any]]:
    # timeout: 5s
    # return: {"registrar": str, "expires_at": datetime, "nameservers": List[str]}
    # on fail: return None, set scan_status='whois_failed', continue scoring
```

### Scoring
```python
def score_domain(domain: str, signals: Dict, provider: str, mx_records: List[str]) -> Dict[str, Any]:
    # validate domain first
    # check hard-fail rules (e.g., missing MX)
    # load rules.json
    # calculate base_score + provider_points + signal_points - risk_points
    # determine segment (order matters)
    # return: {"score": int, "segment": str, "reason": str}
```

### Email Generation
```python
def generate_generic_emails(domain: str) -> List[str]:
    # normalize domain
    # generate emails from GENERIC_LOCAL_PARTS list
    # return sorted unique list of emails
```

### Email Validation
```python
def validate_email(email: str, use_smtp: bool = False) -> EmailValidationResult:
    # syntax check (regex)
    # MX check (DNS)
    # optional SMTP check (if use_smtp=True)
    # return EmailValidationResult with status, confidence, checks
```

## Documentation Management

### ‚ö†Ô∏è AUTOMATIC DOCUMENTATION UPDATES (ALWAYS ACTIVE)
**IMPORTANT**: When you create/modify code, ALWAYS update documentation automatically:

1. **New API endpoints** (`app/api/*.py`) ‚Üí Update README.md API Endpoints section
2. **New test files** (`tests/*.py`) ‚Üí Update CHANGELOG.md under "Added" ‚Üí "G9: Tests"
3. **New core modules** (`app/core/*.py`) ‚Üí Update CHANGELOG.md with module description
4. **Phase completion** (TODO status = "Completed") ‚Üí Run full phase completion workflow

**DO NOT WAIT** for user to ask - update documentation immediately after code changes.

### Phase Completion Workflow
When a phase is completed (TODO status = "Completed"):
1. **Archive TODO**: `scripts/manage_docs.sh phase-complete <phase> <name>`
2. **Update CHANGELOG.md**: Add phase changes under `[Unreleased]` ‚Üí `### Added`
3. **Update README.md**: Mark completed features in Features section
4. **Update docs/README.md**: Add phase to "Archived Documentation" section
5. **Archive related docs**: Move phase-specific docs from `docs/active/` to `docs/archive/`

### Documentation Structure
- `docs/active/` - Current phase documentation (keep minimal, max 5-7 files)
  - **Current**: 9 files (2025-01-30) - Target: 5-7 files
  - **Recent cleanup**: D365 Phase 2.5, 3, 2.9 (old wiring) archived (2025-01-30)
  - **Files**: HUNTER-STATE-v1.0.md, CRITICAL-3-HAMLE-PRODUCT-READY.md, CORE-FREEZE-D365-PUSH-PLAN.md, D365-PHASE-2.9-E2E-RUNBOOK.md, G21-ROADMAP-CURRENT.md, KALAN-ISLER-PRIORITY.md, NO-BREAK-REFACTOR-PLAN.md, PRE-D365-ROAST-SPRINT-TASK-BOARD.md, SALES-ENGINE-V1.1.md
- `docs/archive/` - Completed phase documentation (date-prefixed)
  - **Recent**: D365 Phase 2.5, 3, 2.9 (old wiring) archived (2025-01-30)
  - **Recent**: Hamle 1 dosyalarƒ± archived (2025-01-30)
- `docs/reference/` - Reference guides (development, setup, troubleshooting) - NOT in `docs/active/`
  - **New**: `DEV-PROD-DIFFERENCES.md` (2025-01-30) - Dev vs Prod environment comparison
  - **New**: `D365-PHASE-2.9-E2E-RUNBOOK.md` reference added to docs/README.md
  - **D365 Lead Documentation** (2025-01-30):
    - `docs/reference/LEAD-DATA-DICTIONARY.md` - Full data dictionary with logical names (`hnt_` prefix confirmed from D365)
    - `docs/reference/LEAD-FORM-ARCHITECTURE.md` - Form structure, sections, tabs, control types
    - `docs/reference/LEAD-VIEWS.md` - View configuration, filters, sort criteria, recommended views
    - `docs/reference/LEAD-TABLE-FORM-ANALYSIS.md` - Original analysis document (v1.0)
    - `docs/reference/D365-OPTION-SET-MAPPING.md` - Option Set value mapping guide (string ‚Üí integer, added 2025-01-30)
- `docs/prompts/` - Important prompts (date-prefixed, archive when done)
  - **Recent**: Roast sprint prompts saved (2025-01-30)
    - `2025-01-30-cursor-roast-prompt-v1.0.md`
    - `2025-01-30-cursor-roast-prompt-v1.1-pro.md`
    - `2025-01-30-cursor-roast-results-v1.0.md`
    - `2025-01-30-cursor-roast-results-v1.1-pro.md`
- `docs/todos/` - TODO lists (archive when phase complete)
  - **Current**: INTEGRATION-ROADMAP.md (Phase 3 IN PROGRESS), G21-architecture-refactor.md (Phase 4 PAUSED)
  - **Status**: Phase 3 (D365) - Backend %94 + UI completed, E2E runbook ready
- `docs/plans/` - Project plans

### When to Archive
- Phase complete ‚Üí Run phase completion workflow (see above)
  - **Recent**: D365 Phase 2.5, 3 archived (2025-01-30)
  - **Recent**: Hamle 1 dosyalarƒ± archived (2025-01-30)
- Prompt no longer referenced ‚Üí Archive prompt
- Keep only active/current documentation visible
- **Sprint boards**: Can stay active if they have reference value (decision logs, etc.)
  - **Example**: `PRE-D365-ROAST-SPRINT-TASK-BOARD.md` (completed, but has decision log)
- **Phase documentation**: Archive immediately when phase completes
  - **Recent**: D365 Phase 2.5, 3, 2.9 (old wiring) archived (2025-01-30)

## Post-MVP Sprint Planning (G15-G19)

### Sprint 2 (G15) - Bulk Scan & Async Queue ‚úÖ Completed
- ‚úÖ Use async queue (Celery + Redis)
- ‚úÖ Implement rate limiting (DNS: 10 req/s, WHOIS: 5 req/s)
- ‚úÖ Progress tracking via Redis or DB
- ‚úÖ Bulk scan endpoint (`POST /scan/bulk`)

### Sprint 3 (G16) - Webhook + Basit Lead Enrichment ‚úÖ Completed
- ‚úÖ Simple API Key auth (no OAuth yet)
- ‚úÖ Basic lead enrichment (contact_emails, contact_quality_score, linkedin_pattern)
- ‚úÖ Webhook endpoint (`POST /ingest/webhook`)

### Sprint 4 (G17) - Notes/Tags/Favorites + Basit PDF ‚úÖ Completed
- ‚úÖ Session-based favorites (no auth required yet)
- ‚úÖ Simple PDF generation (no AI)
- ‚úÖ Auto-tagging (security-risk, migration-ready, expire-soon, etc.)

### Sprint 5 (G18) - ReScan + Alerts + Enhanced Scoring ‚úÖ Completed
- ‚úÖ History tables for change tracking
- ‚úÖ Enhanced scoring (signal-based improvements, NO AI)
- ‚úÖ ReScan infrastructure (manual and bulk)
- ‚úÖ Alerts system (MX changed, DMARC added, expiry, score changed)

### Sprint 6 (G19) - Auth + UI + Advanced Features ‚úÖ Completed
- ‚úÖ Microsoft SSO authentication
- ‚úÖ UI/Dashboard upgrade
- ‚úÖ AI Features (optional)
- ‚úÖ Contact Finder (optional)

### P1 Performance & Infrastructure ‚úÖ Completed (2025-01-28)
- ‚úÖ **Alembic Migration System** - Migration history tracking, rollback capability
- ‚úÖ **Distributed Rate Limiting** - Redis-based rate limiting for multi-worker
- ‚úÖ **Caching Layer** - Redis-based distributed caching (DNS, WHOIS, Provider, Scoring)
- ‚úÖ **Bulk Operations Optimization** - Batch processing, deadlock prevention
- ‚úÖ **API Versioning** - `/api/v1/` structure with backward compatibility
- **Reference**: `docs/active/P1-IMPLEMENTATION-PLAYBOOK.md`

### ‚úÖ Stabilization Sprint (Tamamlandƒ± - 2025-01-28)
- ‚úÖ **G√ºn 1: Core Stabilizasyon** - Alembic tests, rate limiting tests, bulk tests, API backward compat (Tamamlandƒ±)
- ‚úÖ **G√ºn 2: Monitoring & Safety** - Cache metrics, rate limit metrics, error tracking, simulation tests (Tamamlandƒ±)
- ‚úÖ **G√ºn 3: UI Stabilizasyon** - Table cleanup, modal improvements, export/PDF, tooltip system (Tamamlandƒ±)
- **Result**: v1.1-stable (Enterprise-Ready / UI-Stable / Integration-Ready)
- **Reference**: `docs/active/STABILIZATION-SPRINT-PLAN-v1.0.md` (completed)
- **UI Checklist**: `docs/active/UI-STABILIZATION-CHECKLIST-v1.0.md` (completed)

### üîÑ G21: Architecture Refactor (In Progress - 2025-01-28)
- **Goal**: Refactor Hunter to core purpose - "Thin, muscular signal engine"
- **Strategy**: Zero-downtime, additive-first approach
- **Phases**: 6 phases (Preparation ‚Üí Deprecation ‚Üí Sales Engine ‚Üí Read-Only ‚Üí Migration ‚Üí Cleanup)
- **Risk Level**: 0-5% (with proper execution)
- **Reference**: `docs/active/NO-BREAK-REFACTOR-PLAN.md` (detailed plan)
- **Architectural Decision**: `docs/prompts/2025-01-28-hunter-architecture-refactor-decision.md`
- **TODO**: `docs/todos/G21-architecture-refactor.md`

## Questions to Ask Before Implementing

1. Is this in MVP scope? (Check Cut List)
2. **Is this in the correct Post-MVP sprint?** (Check `docs/plans/2025-11-14-FINAL-ROADMAP.md`)
3. **Is this a P1 performance/infrastructure task?** (Check `docs/active/KALAN-ISLER-PRIORITY.md` and `docs/active/P1-IMPLEMENTATION-PLAYBOOK.md`)
4. **Is this a Stabilization Sprint task?** (‚úÖ Completed - 2025-01-28 - v1.1-stable released)
5. **Is this a G21 Architecture Refactor task?** (üîÑ In Progress - 2025-01-28 - Check `docs/active/NO-BREAK-REFACTOR-PLAN.md`)
6. Does this require external API calls? (Handle timeouts/errors)
7. Will this log PII? (Only log domain)
8. Is this testable? (Write tests)
9. Does this break Docker setup? (Verify setup_dev.sh still works)
10. **Did I update documentation?** (CHANGELOG.md, README.md, docs/README.md when phase completes)
11. **Am I implementing features in the wrong sprint?** (Check roadmap for correct sprint assignment)
12. **Stabilization Sprint**: ‚úÖ Completed (2025-01-28) - v1.1-stable released (Enterprise-Ready / UI-Stable / Integration-Ready)
13. **G21 Architecture Refactor**: üîÑ In Progress (2025-01-28) - Zero-downtime refactoring, additive-first approach
14. **Pre-D365 Roast Sprint**: ‚úÖ Completed (2025-01-30) - 5/5 critical fixes (security, idempotency, token cache, session lifecycle, retry backoff)
15. **D365 Integration**: üîÑ In Progress (2025-01-30) - Backend %94 + UI completed, E2E runbook ready
16. **Dev vs Prod Parity**: ‚úÖ Code EQUAL, ‚ö†Ô∏è Configuration DIFFERENT (expected) - See `docs/reference/DEV-PROD-DIFFERENCES.md`

