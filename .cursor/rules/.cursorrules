# Dyn365Hunter MVP - Cursor Rules

## Project Context
- **MVP Scope**: FastAPI + PostgreSQL, rule-based scoring, DNS/WHOIS analysis
- **Target**: ‚â§2 minute "kahvelik" analysis flow for sales team
- **MVP Status**: ‚úÖ Completed (G1-G14)
- **Post-MVP Sprint 1 (G14)**: ‚úÖ Completed - CSV Export + UI Mini
- **Post-MVP Sprint 2-5 (G15-G18)**: ‚úÖ Completed - Bulk Scan, Webhook, Notes/Tags/Favorites/PDF, ReScan/Alerts/Enhanced Scoring
- **Post-MVP Sprint 6 (G19)**: ‚úÖ Completed - Auth + UI + Advanced Features
- **UI Patch v1.1**: ‚úÖ Completed - Skor detay modal ve UX iyile≈ütirmeleri (2025-01-28)
- **G20: Domain Intelligence Layer**: ‚úÖ Completed - Local Provider, Tenant Size, DMARC Coverage (2025-01-28)
- **P0 Hardening (G19)**: ‚úÖ Completed - DB Connection Pooling, API Key Security, Structured Logging, Error Tracking, Health Checks
- **P1 Performance**: ‚úÖ Completed (2025-01-28) - Alembic, Distributed Rate Limiting, Caching, Bulk Operations, API Versioning
- **‚úÖ Stabilization Sprint**: ‚úÖ Completed (2025-01-28) - ‚úÖ G√ºn 1 Tamamlandƒ± ‚Üí ‚úÖ G√ºn 2 Tamamlandƒ± ‚Üí ‚úÖ G√ºn 3 Tamamlandƒ± - v1.1-stable (Enterprise-Ready / UI-Stable / Integration-Ready)
- **üîÑ G21: Architecture Refactor**: üîÑ In Progress (2025-01-28) - Hunter Slimming to Core Signal Engine (No-Break Refactor Plan)
- **Completed (Post-MVP)**: Mini UI, CSV export, progress tracking, provider change tracking, duplicate prevention, domain validation, bulk scan, webhook, lead enrichment, notes/tags/favorites, PDF summaries, rescan infrastructure, alerts system, enhanced scoring, domain intelligence (G20)

## Code Style & Standards

### Python
- Use type hints for all functions
- Follow PEP 8 (black formatter preferred)
- Use f-strings for string formatting
- Prefer explicit over implicit (no magic numbers/strings)
- Use `app/core/constants.py` for business logic thresholds (scores, expiry days, bulk limits)

### FastAPI
- Use Pydantic models for request/response validation
- Use dependency injection for DB sessions (`get_db()`)
- Return proper HTTP status codes (201 Created, 400 Bad Request, 404 Not Found, 500 Internal Server Error)
- Use async/await only if needed (DB I/O can be sync for MVP)

### Database
- Use SQLAlchemy ORM (no raw SQL except in schema.sql)
- Domain is UNIQUE key in `companies` table
- Use idempotent upsert for companies (ON CONFLICT DO UPDATE)
- Always use transactions for multi-step operations
- **Duplicate Prevention**: Delete existing LeadScore/DomainSignal before creating new ones (prevents duplicates)
- **Provider Change Tracking**: Log provider changes to `provider_change_history` table when detected
- **Change Detection**: History tables (`signal_change_history`, `score_change_history`) for tracking changes over time

### Error Handling
- DNS timeout: 10s max, return None/error status, set `scan_status='dns_timeout'`
- WHOIS timeout: 5s max, graceful fail (return None), set `scan_status='whois_failed'`
- RDAP timeout: 3s max (fallback to WHOIS)
- SMTP timeout: 3s max (for email validation)
- Invalid domain: Return 400 Bad Request with clear error message
- Never crash on external API failures (DNS/WHOIS) - continue with partial data
- Celery task timeout: 900s (15 minutes) per task

### Logging & PII
- **CRITICAL**: Log only domain, NEVER log email or company_name
- Use structured logging (JSON format preferred)
- Log level: INFO for normal operations, ERROR for failures, DEBUG for development

### Testing
- Write tests for all core functions (normalizer, analyzer, scorer)
- Test edge cases: invalid domains, timeouts, malformed CSV, missing MX records
- Use pytest with pytest-mock for mocking DNS/WHOIS
- Target: ‚â•70% code coverage for core modules
- All tests must pass before commit (214+ tests)
- CI/CD enforces: black formatting, flake8 linting, mypy type checking

## MVP Scope Discipline

### ‚úÖ IN SCOPE
- Health check (`GET /healthz`) - Database connection status
- Single domain ingestion (`POST /ingest/domain`)
- CSV/Excel ingestion (`POST /ingest/csv`) - parse + normalize + insert + optional auto-scan
  - CSV support (.csv)
  - Excel support (.xlsx, .xls)
  - Auto-detect columns (`auto_detect_columns` query parameter) for OSB Excel files
  - Auto-scan (`auto_scan=true` query parameter) - Automatically scan domains after ingestion
  - Progress tracking - Real-time job progress updates via `/jobs/{job_id}`
- Single domain scan (`POST /scan/domain`) - DNS + WHOIS + scoring
  - Provider change detection and logging
  - Duplicate prevention (delete old records before creating new ones)
- Leads query (`GET /leads` with filters)
- Single lead query (`GET /leads/{domain}`)
- Dashboard endpoint (`GET /dashboard`) - Aggregated statistics
- Priority Score feature - Lead prioritization (1-6 scale)
- Email generation (`POST /email/generate`) - Generic email addresses for domains
- Email validation (`POST /email/generate-and-validate`) - Syntax, MX, optional SMTP validation
- **Mini UI** (`/mini-ui/`) - Simple web interface for demo and internal use (API_BASE_URL configurable via `window.HUNTER_API_BASE_URL`)
- **CSV/Excel export** (`GET /leads/export`) - Export leads with filters
- **Provider change tracking** - Automatic detection and history logging
- **Duplicate prevention** - Automatic cleanup of duplicate records
- **Domain validation** - Enhanced validation to filter invalid domains
- **Bulk scan** (`POST /scan/bulk`) - Async bulk domain scanning with Celery + Redis
- **Webhook ingestion** (`POST /ingest/webhook`) - API key authenticated webhook endpoint
- **Lead enrichment** - Contact emails, quality score, LinkedIn pattern detection
- **Notes/Tags/Favorites** - CRM-lite features with session-based favorites
- **PDF summaries** (`GET /leads/{domain}/summary.pdf`) - Account summary PDF generation
- **ReScan infrastructure** (`POST /scan/{domain}/rescan`, `POST /scan/bulk/rescan`) - Manual and bulk rescan with change detection
- **Alerts system** (`GET /alerts`, `POST /alerts/config`) - Change alerts (MX, DMARC, expiry, score)
- **Enhanced scoring** - Signal-based improvements (DKIM none penalty, SPF multiple includes risk)
- Docker Compose setup
- Basic tests (8 test files)

### ‚ùå OUT OF SCOPE (Post-MVP - Sprint 6'da planlandƒ±)
- **Sprint 6 (G19)**: Auth + UI + Advanced Features - üìã Planlandƒ±
- **Still Out of Scope**: D365 adapter, `scripts/demo_run.sh`
- **Note**: Redis/Queue ve Scheduler Sprint 2-5'te eklendi (Celery + Redis)

## File Structure Rules

### Required Files (P0)
- `Dockerfile`, `docker-compose.yml`, `.dockerignore`
- `setup_dev.sh` (one-command setup)
- `.env.example` (all required env vars)
- `requirements.txt` (pinned versions)
- `app/main.py` (FastAPI app + `/healthz`)
- `app/config.py` (Pydantic Settings with `HUNTER_` prefix - use `HUNTER_DATABASE_URL`, `HUNTER_REDIS_URL`, etc.)
- `app/db/schema.sql` (PostgreSQL DDL)
- `app/db/models.py` (SQLAlchemy models) - Includes `ProviderChangeHistory` model
- `app/db/session.py` (DB session factory)
- `app/core/normalizer.py` (includes `is_valid_domain()`), `analyzer_dns.py`, `analyzer_whois.py`, `provider_map.py`, `scorer.py`, `merger.py`, `priority.py`, `importer.py`, `email_generator.py`, `email_validator.py`, `constants.py`, `change_detection.py`, `rescan.py`, `auto_tagging.py`, `notifications.py`
- `app/api/ingest.py`, `scan.py`, `leads.py`, `dashboard.py`, `email_tools.py`, `progress.py`, `jobs.py`, `bulk_scan.py`, `rescan.py`, `webhook.py`, `export.py`, `notes.py`, `tags.py`, `favorites.py`, `pdf.py`, `alerts.py`
- `app/data/providers.json`, `rules.json`
- `tests/test_scan_single.py`, `test_scorer_rules.py`, `test_ingest_csv.py`, `test_api_endpoints.py`, `test_priority.py`, `test_importer_autodetect.py`, `test_email_generator.py`, `test_email_validator.py`
- `README.md`

### File Naming
- Use snake_case for Python files
- Use kebab-case for shell scripts (`setup_dev.sh`)
- Use lowercase for JSON config files (`providers.json`, `rules.json`)

## Implementation Priorities

### P0 (Must Have)
- Docker setup, DB schema, FastAPI skeleton
- Health check endpoint (`/healthz`)
- Domain normalization, ingestion endpoints
- DNS/WHOIS analyzers, provider mapping, scoring
- Scan endpoint, leads API, dashboard endpoint
- Priority score calculation
- Basic tests, README

### P1 (Should Have - Performance & Infrastructure) ‚úÖ Completed (2025-01-28)
- ‚úÖ **Alembic Migration System** - Migration history tracking, rollback capability, schema drift detection
- ‚úÖ **Distributed Rate Limiting** - Redis-based rate limiting for multi-worker deployments
- ‚úÖ **Caching Layer** - Redis-based distributed caching (DNS, WHOIS, Provider, Scoring, Scan)
- ‚úÖ **Bulk Operations Optimization** - Batch processing, deadlock prevention, partial commit recovery
- ‚úÖ **API Versioning** - `/api/v1/` structure with backward compatibility
- **Reference**: `docs/active/P1-IMPLEMENTATION-PLAYBOOK.md` (completed, now reference guide)

### P2 (Nice to Have)
- Performance optimizations, additional test coverage

## Performance Targets
- Single domain scan: ‚â§10s (cold: ‚â§15s acceptable)
- API response: <1s for `/leads` query
- CSV/Excel ingestion: Parse + normalize + insert only (scan separate)
- Email generation: <1s response time
- Email validation (light): <1s response time (syntax + MX only)
- Email validation (full): 10-30s response time (with SMTP check)

## Data Files

### providers.json
- Must contain 10+ providers (M365, Google, Yandex, Hosting, Local, Unknown)
- Include MX root examples for each provider
- Format: `{"providers": [{"name": "M365", "mx_roots": ["outlook.com", "protection.outlook.com"], ...}]}`

### rules.json
- Must contain: `base_score`, `provider_points`, `signal_points`, `segment_rules`
- Segment rules order matters (evaluate top to bottom)
- Format: `{"base_score": 0, "provider_points": {"M365": 50, ...}, "signal_points": {"spf": 10, ...}, "segment_rules": [...]}`

## Docker & Development

### Docker Compose
- PostgreSQL 15-alpine with healthcheck
- FastAPI service with healthcheck
- Use `depends_on.condition: service_healthy` (not just `depends_on`)
- Volume mounts for hot-reload: `./app:/app/app`

### setup_dev.sh
- Check Docker/Docker Compose availability
- Copy `.env.example` to `.env` if not exists
- `docker-compose up -d`
- Wait for PostgreSQL healthcheck (max 30s)
- Run schema migration automatically (Python script or Alembic, NOT manual docker-compose exec)
- Verify `/healthz` endpoint
- Print access URLs

## Guardrails & Validation Rules

### Rate Limiting
- **DNS queries**: 10 req/s per worker (token bucket algorithm)
- **WHOIS queries**: 5 req/s per worker (token bucket algorithm)
- **API Key rate limiting**: Configurable per key (default: 60 req/min)
- Always use `wait_for_dns_rate_limit()` and `wait_for_whois_rate_limit()` in bulk operations

### Bulk Operation Limits
- **Maximum domains per bulk scan/rescan**: 1000 (use `MAX_BULK_SCAN_DOMAINS` from `app/core/constants.py`)
- Validate domain count before processing
- Return 400 Bad Request if limit exceeded

### Environment Variables
- **Always use `HUNTER_` prefix**: `HUNTER_DATABASE_URL`, `HUNTER_REDIS_URL`, etc.
- Load via Pydantic Settings (`app/config.py`)
- Never hardcode database/Redis URLs in code
- Provide defaults for development (Docker Compose service names)

### Constants & Magic Numbers
- **Never use magic numbers**: Use `app/core/constants.py` for all thresholds
- Score thresholds: `MIGRATION_READY_SCORE`, `PRIORITY_1_SCORE`, etc.
- Expiry thresholds: `EXPIRE_SOON_DAYS`
- Bulk limits: `MAX_BULK_SCAN_DOMAINS`

### API Key Authentication
- **Webhook endpoints**: Require `X-API-Key` header
- Use `verify_api_key()` dependency for protected endpoints
- Rate limit per API key (configurable, default: 60 req/min)
- Store hashed keys (SHA-256), never plaintext

### Celery Task Configuration
- **Task timeout**: 900s (15 minutes) per task
- **Max retries**: 2 for transient failures
- **Concurrent tasks**: 5 per worker
- Always use rate limiting in Celery tasks

### CI/CD Guardrails
- **Black formatting**: Enforced in CI (`.github/workflows/lint.yml`)
- **Flake8 linting**: Max line length 127, complexity ‚â§10
- **Type checking**: mypy (non-blocking, ignore missing imports)
- **Test coverage**: Codecov integration
- **All tests must pass**: 214+ tests

## Code Review Checklist

Before marking code as done, verify:
- [ ] Type hints added
- [ ] Error handling implemented (timeouts, invalid input)
- [ ] No PII in logs (domain only)
- [ ] Tests written for new functions
- [ ] MVP scope respected (Post-MVP features: bulk, webhook, export, rescan, alerts are now in scope)
- [ ] Docker Compose still works
- [ ] `/healthz` still responds
- [ ] Rate limiting applied (if bulk/external API calls)
- [ ] Bulk limits enforced (max 1000 domains)
- [ ] Constants used (no magic numbers)
- [ ] Environment variables use `HUNTER_` prefix
- [ ] Black formatting applied
- [ ] All tests passing

## Common Patterns

### Domain Normalization
```python
def normalize_domain(domain: str) -> str:
    # Extract domain from URL if needed
    # punycode decode, strip www, lowercase
    # validate domain format
    # return normalized domain or empty string if invalid

def is_valid_domain(domain: str) -> bool:
    # Check for invalid values (nan, web sitesi, etc.)
    # Validate domain format (dots, TLD, character rules)
    # return True if valid, False otherwise
```

### DNS Analysis
```python
def analyze_dns(domain: str) -> Dict[str, Any]:
    # timeout: 10s
    # return: {"mx_root": str, "spf": bool, "dkim": bool, "dmarc_policy": str}
    # on timeout: return None, set scan_status='dns_timeout'
```

### WHOIS Analysis
```python
def get_whois_info(domain: str) -> Optional[Dict[str, Any]]:
    # timeout: 5s
    # return: {"registrar": str, "expires_at": datetime, "nameservers": List[str]}
    # on fail: return None, set scan_status='whois_failed', continue scoring
```

### Scoring
```python
def score_domain(domain: str, signals: Dict, provider: str, mx_records: List[str]) -> Dict[str, Any]:
    # validate domain first
    # check hard-fail rules (e.g., missing MX)
    # load rules.json
    # calculate base_score + provider_points + signal_points - risk_points
    # determine segment (order matters)
    # return: {"score": int, "segment": str, "reason": str}
```

### Email Generation
```python
def generate_generic_emails(domain: str) -> List[str]:
    # normalize domain
    # generate emails from GENERIC_LOCAL_PARTS list
    # return sorted unique list of emails
```

### Email Validation
```python
def validate_email(email: str, use_smtp: bool = False) -> EmailValidationResult:
    # syntax check (regex)
    # MX check (DNS)
    # optional SMTP check (if use_smtp=True)
    # return EmailValidationResult with status, confidence, checks
```

## Documentation Management

### ‚ö†Ô∏è AUTOMATIC DOCUMENTATION UPDATES (ALWAYS ACTIVE)
**IMPORTANT**: When you create/modify code, ALWAYS update documentation automatically:

1. **New API endpoints** (`app/api/*.py`) ‚Üí Update README.md API Endpoints section
2. **New test files** (`tests/*.py`) ‚Üí Update CHANGELOG.md under "Added" ‚Üí "G9: Tests"
3. **New core modules** (`app/core/*.py`) ‚Üí Update CHANGELOG.md with module description
4. **Phase completion** (TODO status = "Completed") ‚Üí Run full phase completion workflow

**DO NOT WAIT** for user to ask - update documentation immediately after code changes.

### Phase Completion Workflow
When a phase is completed (TODO status = "Completed"):
1. **Archive TODO**: `scripts/manage_docs.sh phase-complete <phase> <name>`
2. **Update CHANGELOG.md**: Add phase changes under `[Unreleased]` ‚Üí `### Added`
3. **Update README.md**: Mark completed features in Features section
4. **Update docs/README.md**: Add phase to "Archived Documentation" section
5. **Archive related docs**: Move phase-specific docs from `docs/active/` to `docs/archive/`

### Documentation Structure
- `docs/active/` - Current phase documentation (keep minimal, max 5-7 files)
- `docs/archive/` - Completed phase documentation (date-prefixed)
- `docs/prompts/` - Important prompts (date-prefixed, archive when done)
- `docs/todos/` - TODO lists (archive when phase complete)
- `docs/plans/` - Project plans

### When to Archive
- Phase complete ‚Üí Run phase completion workflow (see above)
- Prompt no longer referenced ‚Üí Archive prompt
- Keep only active/current documentation visible

## Post-MVP Sprint Planning (G15-G19)

### Sprint 2 (G15) - Bulk Scan & Async Queue ‚úÖ Completed
- ‚úÖ Use async queue (Celery + Redis)
- ‚úÖ Implement rate limiting (DNS: 10 req/s, WHOIS: 5 req/s)
- ‚úÖ Progress tracking via Redis or DB
- ‚úÖ Bulk scan endpoint (`POST /scan/bulk`)

### Sprint 3 (G16) - Webhook + Basit Lead Enrichment ‚úÖ Completed
- ‚úÖ Simple API Key auth (no OAuth yet)
- ‚úÖ Basic lead enrichment (contact_emails, contact_quality_score, linkedin_pattern)
- ‚úÖ Webhook endpoint (`POST /ingest/webhook`)

### Sprint 4 (G17) - Notes/Tags/Favorites + Basit PDF ‚úÖ Completed
- ‚úÖ Session-based favorites (no auth required yet)
- ‚úÖ Simple PDF generation (no AI)
- ‚úÖ Auto-tagging (security-risk, migration-ready, expire-soon, etc.)

### Sprint 5 (G18) - ReScan + Alerts + Enhanced Scoring ‚úÖ Completed
- ‚úÖ History tables for change tracking
- ‚úÖ Enhanced scoring (signal-based improvements, NO AI)
- ‚úÖ ReScan infrastructure (manual and bulk)
- ‚úÖ Alerts system (MX changed, DMARC added, expiry, score changed)

### Sprint 6 (G19) - Auth + UI + Advanced Features ‚úÖ Completed
- ‚úÖ Microsoft SSO authentication
- ‚úÖ UI/Dashboard upgrade
- ‚úÖ AI Features (optional)
- ‚úÖ Contact Finder (optional)

### P1 Performance & Infrastructure ‚úÖ Completed (2025-01-28)
- ‚úÖ **Alembic Migration System** - Migration history tracking, rollback capability
- ‚úÖ **Distributed Rate Limiting** - Redis-based rate limiting for multi-worker
- ‚úÖ **Caching Layer** - Redis-based distributed caching (DNS, WHOIS, Provider, Scoring)
- ‚úÖ **Bulk Operations Optimization** - Batch processing, deadlock prevention
- ‚úÖ **API Versioning** - `/api/v1/` structure with backward compatibility
- **Reference**: `docs/active/P1-IMPLEMENTATION-PLAYBOOK.md`

### ‚úÖ Stabilization Sprint (Tamamlandƒ± - 2025-01-28)
- ‚úÖ **G√ºn 1: Core Stabilizasyon** - Alembic tests, rate limiting tests, bulk tests, API backward compat (Tamamlandƒ±)
- ‚úÖ **G√ºn 2: Monitoring & Safety** - Cache metrics, rate limit metrics, error tracking, simulation tests (Tamamlandƒ±)
- ‚úÖ **G√ºn 3: UI Stabilizasyon** - Table cleanup, modal improvements, export/PDF, tooltip system (Tamamlandƒ±)
- **Result**: v1.1-stable (Enterprise-Ready / UI-Stable / Integration-Ready)
- **Reference**: `docs/active/STABILIZATION-SPRINT-PLAN-v1.0.md` (completed)
- **UI Checklist**: `docs/active/UI-STABILIZATION-CHECKLIST-v1.0.md` (completed)

### üîÑ G21: Architecture Refactor (In Progress - 2025-01-28)
- **Goal**: Refactor Hunter to core purpose - "Thin, muscular signal engine"
- **Strategy**: Zero-downtime, additive-first approach
- **Phases**: 6 phases (Preparation ‚Üí Deprecation ‚Üí Sales Engine ‚Üí Read-Only ‚Üí Migration ‚Üí Cleanup)
- **Risk Level**: 0-5% (with proper execution)
- **Reference**: `docs/active/NO-BREAK-REFACTOR-PLAN.md` (detailed plan)
- **Architectural Decision**: `docs/prompts/2025-01-28-hunter-architecture-refactor-decision.md`
- **TODO**: `docs/todos/G21-architecture-refactor.md`

## Questions to Ask Before Implementing

1. Is this in MVP scope? (Check Cut List)
2. **Is this in the correct Post-MVP sprint?** (Check `docs/plans/2025-11-14-FINAL-ROADMAP.md`)
3. **Is this a P1 performance/infrastructure task?** (Check `docs/active/KALAN-ISLER-PRIORITY.md` and `docs/active/P1-IMPLEMENTATION-PLAYBOOK.md`)
4. **Is this a Stabilization Sprint task?** (‚úÖ Completed - 2025-01-28 - v1.1-stable released)
5. **Is this a G21 Architecture Refactor task?** (üîÑ In Progress - 2025-01-28 - Check `docs/active/NO-BREAK-REFACTOR-PLAN.md`)
6. Does this require external API calls? (Handle timeouts/errors)
7. Will this log PII? (Only log domain)
8. Is this testable? (Write tests)
9. Does this break Docker setup? (Verify setup_dev.sh still works)
10. **Did I update documentation?** (CHANGELOG.md, README.md, docs/README.md when phase completes)
11. **Am I implementing features in the wrong sprint?** (Check roadmap for correct sprint assignment)
12. **Stabilization Sprint**: ‚úÖ Completed (2025-01-28) - v1.1-stable released (Enterprise-Ready / UI-Stable / Integration-Ready)
13. **G21 Architecture Refactor**: üîÑ In Progress (2025-01-28) - Zero-downtime refactoring, additive-first approach

