---
alwaysApply: true
---
# Documentation Management Rules

## Purpose
Efficient documentation lifecycle management to optimize token usage and maintain clear project context.

## Documentation Lifecycle

1. **Active** (`docs/active/`) - Current phase only
2. **Archive** (`docs/archive/`) - Completed phases (date-prefixed)
3. **Prompts** (`docs/prompts/`) - Important conversations (date-prefixed)
4. **TODOs** (`docs/todos/`) - Task tracking (archive when complete)

## Archive Rules

### When to Archive
- ✅ Phase complete → Archive TODO and phase documentation
- ✅ Prompt no longer actively referenced → Archive prompt
- ✅ Feature complete → Archive related documentation

### Archive Format
- Date prefix: `YYYY-MM-DD-filename.md`
- Use `scripts/manage_docs.sh archive-*` commands

## Active Documentation Guidelines

### Keep Minimal
- Only current phase documentation in `active/`
- Maximum 5-7 active files
- Archive immediately when phase completes

### What to Keep Active
- Current phase TODO
- Current phase roadmap section
- Active prompts (if actively referenced)
- Current acceptance criteria
- **Feature documentation** - New features (provider change tracking, duplicate prevention, domain validation, bulk scan, webhook, notes/tags/favorites, rescan, alerts, IP enrichment)
- **Reference guides** - Development environment, testing, troubleshooting guides

## Prompt Management

### Save Important Prompts
- Complex decisions
- Architecture discussions
- Important context
- Format: `YYYY-MM-DD-prompt-name.md`

### Archive Prompts
- When no longer actively referenced
- After decisions are implemented
- Use `scripts/manage_docs.sh archive-prompt <file>`

## TODO Management

### Create TODOs
- One TODO per phase: `G1-foundation.md`, `G2-database.md`, etc.
- Update status: In Progress → Completed → Archived
- Use `scripts/manage_docs.sh create-todo <phase> <name>`

### Archive TODOs
- When phase is complete
- Move to `docs/archive/` with date prefix
- Use `scripts/manage_docs.sh archive-todo <file>`

## Memory Optimization

### Token Efficiency
- Don't repeat archived information
- Reference archived docs when needed
- Keep active context minimal
- Archive immediately when done

### Context Management
- Reference `docs/active/` for current work
- Check `docs/archive/` for historical context
- Use `docs/prompts/` for important decisions
- Use `docs/todos/` for task tracking

## Guardrails & Validation Rules

### Documentation Guardrails
- **Active Docs Limit**: Maximum 5-7 files in `docs/active/` (enforced)
- **Archive Immediately**: Archive completed phase docs immediately (don't wait)
- **Date Prefix**: All archived files must have `YYYY-MM-DD-` prefix (required)
- **Auto-Update**: Always update README.md, CHANGELOG.md, docs/README.md when code changes
- **Token Efficiency**: Don't repeat archived information, reference when needed
- **Feature Docs**: Archive feature documentation when complete (e.g., PROVIDER-CHANGE-TRACKING.md)
- **Planning Docs**: Archive completed planning docs to `docs/archive/`

### Validation Rules
- **Before Archiving**: Verify phase is actually complete (check TODO status)
- **Before Creating**: Check if similar documentation already exists
- **Before Updating**: Verify documentation is still active (not archived)
- **Format Check**: Ensure date prefix format is correct (`YYYY-MM-DD-`)
- **Link Check**: Update all references when moving files to archive

### Database Migration & Reset Guardrails (CRITICAL - Lessons Learned 2025-01-29)
- **⚠️ schema.sql DEPRECATED**: `app/db/schema.sql` is **OUTDATED** and **MUST NOT** be used for database reset
  - **Reason**: Missing G20 columns (`tenant_size`, `local_provider`, `dmarc_coverage`) and CSP P-Model columns
  - **Impact**: Causes schema mismatches, missing columns, view errors, API failures
  - **Official Way**: Use `./scripts/reset_db_with_alembic.sh` or `Base.metadata.create_all()` + Alembic stamp
- **⚠️ Legacy SQL Migrations DEPRECATED**: `app/db/migrations/legacy/*.sql` files are **ARCHIVED** and **MUST NOT** be used
  - **Reason**: Transaction-unsafe, can fail mid-execution, out of sync with Alembic migrations
  - **Location**: Moved to `docs/archive/legacy-migrations/` (historical reference only)
  - **Official Way**: All schema changes must use Alembic migrations (`alembic/versions/`)
- **Database Reset Policy** (MANDATORY):
  - ❌ **DO NOT**: Use `schema.sql` or legacy SQL migrations for database reset
  - ❌ **DO NOT**: Combine `schema.sql` with legacy migrations (causes schema mismatches)
  - ✅ **DO**: Use `./scripts/reset_db_with_alembic.sh` for database reset (official script)
  - ✅ **DO**: Use `Base.metadata.create_all()` + Alembic stamp for fresh database setup
  - ✅ **DO**: Always use Alembic migrations (`alembic upgrade head`) for schema changes
  - ✅ **DO**: Verify critical columns after reset (`tenant_size`, `local_provider`, `dmarc_coverage`, P-Model columns)
- **Base Revision Migration Issues**:
  - Base revision (`08f51db8dce0_base_revision.py`) assumes tables exist (ALTER operations)
  - **Fix**: Use `Base.metadata.create_all()` first, then stamp base revision as applied
  - **Pattern**: Create tables from models → Stamp migrations → Run remaining migrations
- **API SQL Query Guardrails**:
  - ❌ **DO NOT**: SELECT columns that may not exist in view (`tenant_size`, `local_provider`, `dmarc_coverage`)
  - ✅ **DO**: Use dynamic column checking or `getattr()` when reading from view
  - ✅ **DO**: Verify view columns exist before using in SQL queries
  - **Example**: `leads_ready` view may not have all columns depending on migration state
- **leads_ready View Maintenance**:
  - View must include P-Model columns (`technical_heat`, `commercial_segment`, `commercial_heat`, `priority_category`, `priority_label`)
  - View must be updated when new columns are added to `lead_scores` table
  - CSP P-Model migration (`f786f93501ea`) handles view update dynamically
- **Migration Verification** (After Reset):
  - Verify `companies.tenant_size` exists (G20 column)
  - Verify `domain_signals.local_provider` and `domain_signals.dmarc_coverage` exist (G20 columns)
  - Verify `lead_scores` P-Model columns exist (`technical_heat`, `commercial_segment`, `commercial_heat`, `priority_category`, `priority_label`)
  - Verify `leads_ready` view has all expected columns
- **Reference Documentation**:
  - `docs/reference/PRODUCTION-DEPLOYMENT-GUIDE.md` - Migration Flow section (reset policy)
  - `docs/reference/TROUBLESHOOTING-GUIDE.md` - Database Reset Issues section
  - `docs/archive/legacy-migrations/README.md` - Why legacy migrations are deprecated

## Commands

```bash
# List documentation
scripts/manage_docs.sh list

# Archive TODO
scripts/manage_docs.sh archive-todo G1-foundation.md

# Archive prompt
scripts/manage_docs.sh archive-prompt 2025-11-12-initial-setup.md

# Create TODO
scripts/manage_docs.sh create-todo G2 database-schema

# Create prompt
scripts/manage_docs.sh create-prompt api-design
```
